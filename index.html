<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <title>Contacalorie giornaliero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">


  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000000;
      color: #ffffff;
      overflow-x: hidden;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .date-label {
      font-weight: 600;
      font-size: 1rem;
      color: #ffffff;
    }

    .date-nav {
      display: flex;
      gap: 2rem;
      /* più spazio tra i due pulsanti */
    }

    #prev-day-btn,
    #next-day-btn {
      padding: 0.7rem 1.2rem;
      /* pulsanti più grandi */
      font-size: 1.5rem;
      /* simboli < e > più grandi */
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      background: #ffffff;
      color: #000000;
      cursor: pointer;
    }

    .btn-secondary {
      background: #4b5563;
      color: #f9fafb;
    }

    .btn-full {
      width: 100%;
      margin-top: 1rem;
      font-size: 1rem;
    }

    #totals {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      /* 4 colonne in una riga */
      gap: 0.5rem;
      margin-bottom: 1rem;
      text-align: center;
      /* valori e label centrati come in foto */
    }


    .total-card {
      background: #111827;
      border-radius: 0.9rem;
      padding: 0.6rem 0.7rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      color: #f9fafb;
    }

    .total-label {
      font-size: 0.8rem;
      color: #ffffff;
      /* bianco */
      font-weight: 400;
      /* regular */
      text-transform: none;
      letter-spacing: 0;
    }


    .total-value {
      font-size: 1rem;
      font-weight: 700;
      margin-top: 0.15rem;
      color: #ffffff;
    }

    #food-list-section {
      margin-bottom: 1rem;
    }

    #empty-day-message {
      font-size: 0.9rem;
      color: #9ca3af;
      text-align: center;
      margin-top: 1rem;
    }

    #food-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .food-item {
      background: #111827;
      border-radius: 0.9rem;
      padding: 0.7rem 0.8rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      transition: transform 0.15s ease-out, opacity 0.15s ease-out;
      touch-action: pan-y;
      color: #f9fafb;
    }

    .food-main {
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    .food-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: #ffffff;
    }

    .food-quantity {
      font-size: 0.9rem;
      color: #ffffff;
      font-weight: 400;
      margin-left: 0.2rem;
      /* QUI decidi tu la distanza dal nome */
    }


    .delete-btn {
      border: none;
      background: #7f1d1d;
      color: #fee2e2;
      border-radius: 999px;
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: flex-start;
      /* MODIFICATO: non più center */
      justify-content: center;
      padding-top: 10vh;
      /* AGGIUNTO: la alza */
      padding-bottom: 6vh;
      /* AGGIUNTO: margine sotto (utile con tastiera) */
      z-index: 20;
    }


    .overlay.hidden {
      display: none;
    }

    .overlay-content {
      background: #111827;
      border-radius: 1rem;
      padding: 1rem;
      width: calc(100% - 2rem);
      max-width: 420px;

      max-height: 90vh;
      /* lasciata come fallback */
      max-height: 90dvh;
      /* AGGIUNTO: migliore su mobile con tastiera */

      overflow-y: auto;
      color: #f9fafb;
      transition: transform 0.2s ease-out;

      /* RIMOSSO:
  position: relative;
  top: -8vh;
  */
    }




    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .overlay-header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: #111827;
      padding-bottom: 0.6rem;
      border-bottom: 1px solid #1f2933;
    }

    .overlay-header-left {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .overlay-subtitle {
      font-size: 0.9rem;
      color: #ffffff;
      font-weight: 400;
    }


    .overlay-title {
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
    }

    .close-btn {
      border: none;
      background: transparent;
      font-size: 1.3rem;
      line-height: 1;
      padding: 0;
      color: #ffffff;
    }

    .field {
      margin-bottom: 0.7rem;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
      color: #e5e7eb;
    }

    .field input {
      width: 100%;
      padding: 0.45rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px solid #374151;
      font-size: 0.9rem;
      background: #000000;
      color: #ffffff;
    }

    .field input::placeholder {
      color: #6b7280;
    }

    .detail-macros {
      display: grid;
      gap: 6px;
      margin-top: 10px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
    }



    .detail-macro-card {
      background: #020617;
      border-radius: 0.7rem;
      padding: 0.4rem 0.5rem;
      color: #f9fafb;
    }

    .detail-macro-label {
      font-size: 0.7rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .detail-macro-value {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 0.1rem;
      color: #ffffff;
    }

    .panel {
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      flex-direction: column;
      z-index: 15;
      color: #ffffff;
    }

    .panel.hidden {
      display: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #1f2933;
      background: #020617;
    }

    .panel-title {
      font-weight: 600;
      font-size: 1rem;
      color: #ffffff;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 1rem 1rem;
      background: #000000;
    }

    .panel-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #ffffff;
    }

    #search-results {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-bottom: 0.9rem;
    }

    .food-search-item {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      padding: 0.35rem 0.7rem;
      font-size: 0.9rem;
      text-align: left;
      color: #f9fafb;
    }

    .food-search-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .food-search-item {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      padding: 0.35rem 0.7rem;
      font-size: 0.9rem;
      text-align: left;
      color: #f9fafb;
      flex: 1;
      /* occupa tutto lo spazio a sinistra */
    }

    .food-search-edit {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 0.7rem;
      /* stessa altezza di Salva alimento */
      font-size: 1rem;
      /* stessa dimensione testo di Salva alimento */
      background: #374151;
      color: #f9fafb;
      cursor: pointer;
      flex-shrink: 0;
      margin-right: 2rem;
    }

    .food-search-delete {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 0.7rem;
      /* stessa altezza di Salva alimento */
      font-size: 1rem;
      /* stessa dimensione testo di Salva alimento */
      background: #7f1d1d;
      color: #fee2e2;
      cursor: pointer;
      flex-shrink: 0;
    }




    .hint-text {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.4rem;
    }

    .two-cols {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
    }

    hr {
      border: none;
      border-top: 1px solid #1f2933;
    }

    #storage-usage {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 10rem;
      margin-bottom: 6rem;
    }

    input::selection {
      color: #ffffff;
      background: #374151;
    }

    #detail-quantity::selection {
      color: #ffffff;
      background: #60a5fa;
      /* azzurro più chiaro */
    }

    .detail-actions {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin: 0.5rem 0 0.5rem;
    }



    #back-to-day-btn {
      font-size: 1rem;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }

    .dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .dialog-overlay.hidden {
      display: none;
    }

    .dialog-content {
      background: #111827;
      border-radius: 1rem;
      padding: 1rem;
      width: calc(100% - 2rem);
      max-width: 420px;
      color: #f9fafb;
      margin-top: 12vh;
      /* sposta il pop-up un po' più in basso */
    }


    .dialog-message {
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .dialog-buttons {
      display: flex;
      justify-content: space-between;
      /* Annulla a sinistra, Ok a destra */
      align-items: center;
      gap: 0;
      /* nessun gap centrale: sono agli estremi */
    }

    /* Pulsanti del popup: stessa altezza di "Salva quantità" */
    .dialog-buttons .btn,
    .dialog-buttons .btn-secondary {
      padding-top: 0.7rem;
      /* aumenta l'altezza */
      padding-bottom: 0.7rem;
      font-size: 1rem;
      /* testo come "Salva quantità" */
    }

    .dialog-buttons .btn,
    .dialog-buttons .btn-secondary {
      min-width: 90px;
      /* o il valore che ti piace di più */
      text-align: center;
    }

    /* --- FIX TASTIERA: alza il popup quando compare la keyboard --- */
    #food-detail-overlay {
      --kb-offset: 0px;
    }

    #food-detail-overlay .overlay-content {
      padding-bottom: calc(1rem + var(--kb-offset));
      transform: translateY(calc(-1 * min(var(--kb-offset), 220px)));
      max-height: calc(90dvh - var(--kb-offset));
    }
  </style>
</head>


<body>
  <div class="app">
    <header>
      <div class="date-label" id="current-date-label"></div>
      <div class="date-nav">
        <button class="btn btn-secondary" id="prev-day-btn" type="button">&lt;</button>
        <button class="btn btn-secondary" id="next-day-btn" type="button">&gt;</button>
      </div>
    </header>

    <section id="totals">
      <div class="total-card">
        <div class="total-label">Calorie</div>
        <div class="total-value"><span id="total-kcal">0</span></div>
      </div>

      <div class="total-card">
        <div class="total-label">Carboidrati</div>
        <div class="total-value"><span id="total-carbs">0</span> g</div>
      </div>

      <div class="total-card">
        <div class="total-label">Proteine</div>
        <div class="total-value"><span id="total-protein">0</span> g</div>
      </div>

      <div class="total-card">
        <div class="total-label">Grassi</div>
        <div class="total-value"><span id="total-fat">0</span> g</div>
      </div>
    </section>

    <section id="food-list-section">
      <ul id="food-list"></ul>
      <div id="empty-day-message" style="display:none;">
        Nessun alimento inserito per questo giorno.
      </div>
    </section>

    <button class="btn btn-full" id="add-food-btn" type="button">Inserisci cibo</button>
  </div>

  <!-- Dettaglio alimento / modifica quantità -->
  <div class="overlay hidden" id="food-detail-overlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <div class="overlay-header-left">
          <div class="overlay-title" id="detail-food-name"></div>

          <div class="overlay-subtitle">
            Carboidrati: <span id="detail-total-carbs">0.0</span> g
          </div>
          <div class="overlay-subtitle">
            Proteine: <span id="detail-total-protein">0.0</span> g
          </div>
          <div class="overlay-subtitle">
            Grassi: <span id="detail-total-fat">0.0</span> g
          </div>
        </div>


        <button class="close-btn" id="close-detail-btn" type="button">&times;</button>
      </div>

      <form id="food-detail-form">
        <div class="field">
          <label for="detail-quantity">Grammi</label>
          <input type="number" id="detail-quantity" min="0" step="1" />
        </div>

        <div class="detail-macros" id="detail-food-macros">
          <div>Calorie: <span id="detail-food-kcal">0</span> kcal</div>
          <div>Carboidrati: <span id="detail-food-carbs">0.0</span> g</div>
          <div>Proteine: <span id="detail-food-protein">0.0</span> g</div>
          <div>Grassi: <span id="detail-food-fat">0.0</span> g</div>
        </div>


        <div class="detail-actions">
          <button class="btn btn-secondary" type="button" id="remove-future-btn">
            Elimina dai giorni successivi
          </button>
          <button class="btn btn-secondary" type="button" id="apply-future-btn">
            Giorni successivi
          </button>
        </div>

        <button class="btn btn-full" type="submit">Salva quantità</button>
      </form>
    </div>
  </div>


  <!-- Pannello inserisci / cerca cibo -->
  <div class="panel hidden" id="add-food-panel">
    <div class="panel-header"></div>

    <div class="panel-body">
      <div class="field">
        <input type="text" id="search-food-input" placeholder="Cerca alimento..." />
      </div>

      <div id="search-results"></div>

      <hr />

      <div class="panel-section-title">Nuovo alimento</div>

      <form id="new-food-form">
        <div class="field">
          <input type="text" id="food-name-input" required placeholder="Nome alimento" />
        </div>

        <div class="two-cols">
          <div class="field">
            <label for="food-kcal-input">Calorie</label>
            <input type="number" id="food-kcal-input" min="0" step="0.1" />
          </div>
          <div class="field">
            <label for="food-carbs-input">Carboidrati</label>
            <input type="number" id="food-carbs-input" min="0" step="0.1" />
          </div>
        </div>

        <div class="two-cols">
          <div class="field">
            <label for="food-protein-input">Proteine</label>
            <input type="number" id="food-protein-input" min="0" step="0.1" />
          </div>
          <div class="field">
            <label for="food-fat-input">Grassi</label>
            <input type="number" id="food-fat-input" min="0" step="0.1" />
          </div>
        </div>

        <button class="btn btn-full" type="submit">Salva alimento</button>

        <button class="btn btn-secondary" id="back-to-day-btn" type="button"
          style="margin-top:8rem; display:block; margin-left:auto; margin-right:auto; padding-left:3rem; padding-right:3rem;">
          Indietro
        </button>

        <div id="storage-usage">Memoria usata: --%</div>
      </form>
    </div>
  </div>

  <!-- Dialog personalizzato -->
  <div class="dialog-overlay hidden" id="app-dialog">
    <div class="dialog-content">
      <div class="dialog-message" id="app-dialog-message"></div>
      <div class="dialog-buttons">
        <button class="btn btn-secondary" type="button" id="dialog-cancel-btn">Annulla</button>
        <button class="btn" type="button" id="dialog-ok-btn">Ok</button>
      </div>
    </div>
  </div>

  <!-- IL TUO JS: UNA SOLA VOLTA, QUI SOTTO -->
  <script>
    (function () {
      const STORAGE_KEYS = {
        foods: "cc_foods_v1",
        days: "cc_days_v1"
      };

      const MAX_STORAGE_BYTES = 5 * 1024 * 1024; // non lo usiamo, ma lo lasciamo

      const dayNames = [
        "Domenica",
        "Lunedì",
        "Martedì",
        "Mercoledì",
        "Giovedì",
        "Venerdì",
        "Sabato"
      ];

      const monthNames = [
        "gennaio",
        "febbraio",
        "marzo",
        "aprile",
        "maggio",
        "giugno",
        "luglio",
        "agosto",
        "settembre",
        "ottobre",
        "novembre",
        "dicembre"
      ];

      // ----------------- DIALOG PERSONALIZZATO -----------------
      function showDialog(options) {
        return new Promise(function (resolve) {
          const overlay = document.getElementById("app-dialog");
          const msgEl = document.getElementById("app-dialog-message");
          const okBtn = document.getElementById("dialog-ok-btn");
          const cancelBtn = document.getElementById("dialog-cancel-btn");

          const hasHtml = !!options.html;
          const hasText = !!(options.message && options.message.trim());

          if (hasHtml) {
            msgEl.innerHTML = options.html;
          } else {
            msgEl.textContent = options.message || "";
          }

          // Se non c’è testo, nascondo proprio la riga del messaggio
          msgEl.style.display = (hasHtml || hasText) ? "" : "none";


          if (options.type === "confirm") {
            cancelBtn.style.display = "";
          } else {
            cancelBtn.style.display = "none";
          }

          overlay.classList.remove("hidden");

          function cleanup(result) {
            overlay.classList.add("hidden");
            okBtn.removeEventListener("click", onOk);
            cancelBtn.removeEventListener("click", onCancel);
            resolve(result);
          }



          function onOk(e) {
            e.stopPropagation();
            cleanup(true);
          }

          function onCancel(e) {
            e.stopPropagation();
            cleanup(false);
          }

          okBtn.addEventListener("click", onOk);
          cancelBtn.addEventListener("click", onCancel);
        });
      }

      function showConfirm(message) {
        return showDialog({ type: "confirm", message: message });
      }

      function showAlert(message) {
        return showDialog({ type: "alert", message: message });
      }

      let foods = {};
      let days = {};

      function updateDetailFoodMacrosLive() {
        if (!editingFoodId) return;

        const food = foods[editingFoodId];
        if (!food) return;

        const qtyInput = document.getElementById("detail-quantity");
        const grams = toNum(qtyInput && qtyInput.value);
        const factor = grams / 100;

        const kcal = toNum(food.kcalPer100) * factor;
        const carbs = toNum(food.carbsPer100) * factor;
        const prot = toNum(food.proteinPer100) * factor;
        const fat = toNum(food.fatPer100) * factor;

        const elKcal = document.getElementById("detail-food-kcal");
        const elCarbs = document.getElementById("detail-food-carbs");
        const elProt = document.getElementById("detail-food-protein");
        const elFat = document.getElementById("detail-food-fat");

        if (elKcal) elKcal.textContent = kcal.toFixed(0);
        if (elCarbs) elCarbs.textContent = carbs.toFixed(1);
        if (elProt) elProt.textContent = prot.toFixed(1);
        if (elFat) elFat.textContent = fat.toFixed(1);
      }


      let currentDate = null;
      let currentDateStr = "";

      let editingEntryIndex = null;
      let editingFoodId = null;
      let draggedIndex = null;
      let lastDeletedEntry = null;
      let undoTimeoutId = null;
      let editingBaseFoodId = null;
      let addFoodPanelOpen = false;
      let detailOverlayOpen = false;


      // ----------------- UTIL -----------------
      function loadFromStorage(key, defaultValue) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return defaultValue;
          const parsed = JSON.parse(raw);
          return parsed || defaultValue;
        } catch (e) {
          console.warn("Impossibile leggere da localStorage:", e);
          return defaultValue;
        }
      }

      function toNum(v) {
        const s = String(v ?? "").trim().replace(/\s+/g, "").replace(",", ".");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      }


      function saveToStorage(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.warn("Impossibile salvare su localStorage:", e);
        }
      }

      function estimateStorageUsageBytes() {
        try {
          let total = 0;
          total += JSON.stringify(foods).length;
          total += JSON.stringify(days).length;
          return total * 2;
        } catch (e) {
          return 0;
        }
      }

      function updateStorageUsageUI() {
        const el = document.getElementById("storage-usage");
        if (!el) return;

        const usedBytes = estimateStorageUsageBytes();
        const usedMB = usedBytes / (1024 * 1024);

        el.textContent = "Memoria usata: " + usedMB.toFixed(3) + " MB su 5 MB";
      }

      function saveFoods() {
        saveToStorage(STORAGE_KEYS.foods, foods);
        updateStorageUsageUI();
      }

      function saveDays() {
        saveToStorage(STORAGE_KEYS.days, days);
        updateStorageUsageUI();
      }

      function pad(n) {
        return n < 10 ? "0" + n : "" + n;
      }

      function formatDate(date) {
        return date.getFullYear() + "-" + pad(date.getMonth() + 1) + "-" + pad(date.getDate());
      }

      function formatDateHuman(date) {
        const dow = dayNames[date.getDay()];
        const d = date.getDate();
        const m = monthNames[date.getMonth()];
        return dow + " " + d + " " + m;
      }

      function escapeHtml(text) {
        if (!text) return "";
        const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
        return text.replace(/[&<>"']/g, function (ch) { return map[ch]; });
      }

      function generateSeriesId() {
        return "s_" + Date.now().toString(36) + "_" + Math.random().toString(16).slice(2);
      }


      // cancella i giorni più vecchi di 1 mese rispetto ad oggi
      function cleanupOldDays() {
        const now = new Date();
        const cutoff = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        const cutoffStr = formatDate(cutoff);

        let changed = false;
        for (const dateStr in days) {
          if (dateStr <= cutoffStr) {
            delete days[dateStr];
            changed = true;
          }
        }
        if (changed) saveDays();
      }

      // ----------------- GESTIONE GIORNO CORRENTE -----------------
      function setCurrentDate(date) {
        currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        cleanupOldDays();

        currentDateStr = formatDate(currentDate);

        const today = new Date();
        const isToday =
          currentDate.getFullYear() === today.getFullYear() &&
          currentDate.getMonth() === today.getMonth() &&
          currentDate.getDate() === today.getDate();

        document.getElementById("current-date-label").textContent =
          isToday ? "Oggi" : formatDateHuman(currentDate);

        if (!days[currentDateStr]) {
          days[currentDateStr] = [];
          saveDays();
        }

        renderDayEntries();
      }

      function renderDayEntries() {
        const list = document.getElementById("food-list");
        const emptyMsg = document.getElementById("empty-day-message");

        list.innerHTML = "";

        const entries = days[currentDateStr] || [];

        emptyMsg.style.display = entries.length ? "none" : "block";

        let totalKcal = 0;
        let totalCarbs = 0;
        let totalProt = 0;
        let totalFat = 0;

        entries.forEach((entry, index) => {
          const food = foods[entry.foodId];
          if (!food) return;

          const quantity = Number(entry.quantity) || 0;
          const factor = quantity / 100;

          const kcal = toNum(food.kcalPer100) * factor;
          const carbs = toNum(food.carbsPer100) * factor;
          const prot = toNum(food.proteinPer100) * factor;
          const fat = toNum(food.fatPer100) * factor;


          totalKcal += kcal;
          totalCarbs += carbs;
          totalProt += prot;
          totalFat += fat;

          const li = document.createElement("li");
          li.className = "food-item";
          li.dataset.index = String(index);
          li.draggable = true;

          li.innerHTML = `
            <div class="food-main">
              <div class="food-name">${escapeHtml(food.name)}</div>
              <div class="food-quantity">${quantity.toFixed(0)} g</div>
            </div>
          `;

          li.addEventListener("click", function () {
            openFoodDetail(index);
          });

          setupSwipeToDelete(li, index);
          setupDragReorder(li, index);

          list.appendChild(li);
        });

        document.getElementById("total-kcal").textContent = totalKcal.toFixed(0);
        document.getElementById("total-carbs").textContent = totalCarbs.toFixed(1);
        document.getElementById("total-protein").textContent = totalProt.toFixed(1);
        document.getElementById("total-fat").textContent = totalFat.toFixed(1);
      }

      function ensureSeriesIdForLegacySeriesIfNeeded(entry) {
        if (!entry) return null;

        // Se già ha seriesId, ok
        if (entry.seriesId) return entry.seriesId;

        // Crea SEMPRE un seriesId (anche se non hai premuto "Giorni successivi")
        const seriesId = generateSeriesId();
        entry.seriesId = seriesId;

        if (!currentDate) return seriesId;

        // Aggancia eventuali copie future "legacy" (stesso foodId ma senza seriesId)
        const weekday = currentDate.getDay();

        for (let i = 1; i <= 365; i++) {
          const d = new Date(currentDate);
          d.setDate(d.getDate() + i);
          if (d.getDay() !== weekday) continue;

          const dateStr = formatDate(d);
          const arr = days[dateStr];
          if (!arr || !arr.length) continue;

          // Prima occorrenza legacy dello stesso alimento
          const idx = arr.findIndex(e => e.foodId === entry.foodId && !e.seriesId);
          if (idx >= 0) {
            arr[idx].seriesId = seriesId;
          }
        }

        return seriesId;
      }




      function reorderDayEntries(fromIndex, toIndex) {
        const entries = days[currentDateStr] || [];
        if (fromIndex < 0 || fromIndex >= entries.length || toIndex < 0 || toIndex >= entries.length) return;

        const moved = entries.splice(fromIndex, 1)[0];
        entries.splice(toIndex, 0, moved);
        days[currentDateStr] = entries;

        // Garantisce SEMPRE seriesId (e aggancia eventuali legacy future)
        const sid = ensureSeriesIdForLegacySeriesIfNeeded(moved);

        // Propaga SEMPRE la posizione nelle settimane successive (stesso weekday)
        if (sid) {
          propagateSeriesPositionToFutureSameWeekday(sid, moved.foodId, toIndex);
        }

        saveDays();
        renderDayEntries();
      }







      function setupDragReorder(element, index) {
        element.addEventListener("dragstart", function () {
          draggedIndex = index;
          element.classList.add("dragging");
          element.style.opacity = "0.6";
        });

        element.addEventListener("dragend", function () {
          element.classList.remove("dragging");
          element.style.opacity = "";
          draggedIndex = null;
        });

        element.addEventListener("dragover", function (e) { e.preventDefault(); });

        element.addEventListener("drop", function (e) {
          e.preventDefault();
          if (draggedIndex === null || draggedIndex === index) return;
          reorderDayEntries(draggedIndex, index);
        });
      }

      // ----------------- UNDO ELIMINAZIONE -----------------
      function deleteEntry(index) {
        const entries = days[currentDateStr] || [];
        if (index < 0 || index >= entries.length) return;

        const removed = entries.splice(index, 1)[0];
        days[currentDateStr] = entries;
        saveDays();
        renderDayEntries();

        lastDeletedEntry = { entry: removed, dateStr: currentDateStr, index: index };

        showUndoBanner();
      }

      function showUndoBanner() {
        let banner = document.getElementById("undo-banner");
        if (!banner) {
          banner = document.createElement("button");
          banner.id = "undo-banner";
          banner.type = "button";
          banner.textContent = "Ripristina alimento";
          banner.style.display = "block";
          banner.style.width = "100%";
          banner.style.marginTop = "8rem";
          banner.style.padding = "0.5rem 0.9rem";
          banner.style.borderRadius = "999px";
          banner.style.border = "none";
          banner.style.background = "#111827";
          banner.style.color = "#f9fafb";
          banner.style.fontSize = "1rem";
          banner.style.cursor = "pointer";

          const app = document.querySelector(".app");
          const addBtn = document.getElementById("add-food-btn");
          if (app && addBtn && addBtn.parentNode === app) {
            if (addBtn.nextSibling) app.insertBefore(banner, addBtn.nextSibling);
            else app.appendChild(banner);
          } else if (app) {
            app.appendChild(banner);
          }
        } else {
          banner.style.display = "block";
        }

        banner.onclick = function () {
          if (!lastDeletedEntry) return;

          const { entry, dateStr, index } = lastDeletedEntry;
          const dayEntries = days[dateStr] || [];

          if (index >= 0 && index <= dayEntries.length) dayEntries.splice(index, 0, entry);
          else dayEntries.push(entry);

          days[dateStr] = dayEntries;
          saveDays();
          if (dateStr === currentDateStr) renderDayEntries();

          lastDeletedEntry = null;
          if (undoTimeoutId) clearTimeout(undoTimeoutId);
          undoTimeoutId = null;
          banner.style.display = "none";
        };

        if (undoTimeoutId) clearTimeout(undoTimeoutId);
        undoTimeoutId = setTimeout(function () {
          if (banner) banner.style.display = "none";
          lastDeletedEntry = null;
        }, 5000);
      }

      function setupSwipeToDelete(element, index) {
        let startX = 0, startY = 0, lastDx = 0, swiping = false;

        element.addEventListener("touchstart", function (e) {
          const t = e.touches[0];
          startX = t.clientX;
          startY = t.clientY;
          lastDx = 0;
          swiping = false;
          element.style.transition = "none";
        });

        element.addEventListener("touchmove", function (e) {
          const t = e.touches[0];
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;

          if (Math.abs(dx) > Math.abs(dy) && dx < -10) {
            swiping = true;
            lastDx = dx;
            element.style.transform = "translateX(" + dx + "px)";
          }
        });

        element.addEventListener("touchend", function () {
          element.style.transition = "transform 0.15s ease-out, opacity 0.15s ease-out";
          if (swiping && lastDx < -80) {
            element.style.transform = "translateX(-120%)";
            element.style.opacity = "0";
            setTimeout(function () { deleteEntry(index); }, 150);
          } else {
            element.style.transform = "translateX(0)";
          }
        });
      }

      function computeTotalProteinForDay(dateStr, overrideIndex, overrideQuantity) {
        const entries = days[dateStr] || [];
        let totalProt = 0;

        entries.forEach((entry, idx) => {
          const food = foods[entry.foodId];
          if (!food) return;

          const qty = (idx === overrideIndex) ? overrideQuantity : (Number(entry.quantity) || 0);
          const factor = (Number(qty) || 0) / 100;

          totalProt += (Number(food.proteinPer100) || 0) * factor;
        });

        return totalProt;
      }

      function computeTotalFatForDay(dateStr, overrideIndex, overrideQuantity) {
        const entries = days[dateStr] || [];
        let totalFat = 0;

        entries.forEach((entry, idx) => {
          const food = foods[entry.foodId];
          if (!food) return;

          const qty = (idx === overrideIndex) ? overrideQuantity : (Number(entry.quantity) || 0);
          const factor = (Number(qty) || 0) / 100;

          totalFat += (Number(food.fatPer100) || 0) * factor;
        });

        return totalFat;
      }

      function updateDetailDayTotalFatLive() {
        const el = document.getElementById("detail-total-fat");
        if (!el) return;
        if (editingEntryIndex == null || !currentDateStr) return;

        const qtyInput = document.getElementById("detail-quantity");
        const liveQty = Number(qtyInput && qtyInput.value) || 0;

        const totalFat = computeTotalFatForDay(currentDateStr, editingEntryIndex, liveQty);
        el.textContent = totalFat.toFixed(1);
      }

      function computeTotalCarbsForDay(dateStr, overrideIndex, overrideQuantity) {
        const entries = days[dateStr] || [];
        let totalCarbs = 0;

        entries.forEach((entry, idx) => {
          const food = foods[entry.foodId];
          if (!food) return;

          const qty = (idx === overrideIndex) ? overrideQuantity : (Number(entry.quantity) || 0);
          const factor = (Number(qty) || 0) / 100;

          totalCarbs += (Number(food.carbsPer100) || 0) * factor;
        });

        return totalCarbs;
      }

      function updateDetailDayTotalCarbsLive() {
        const el = document.getElementById("detail-total-carbs");
        if (!el) return;
        if (editingEntryIndex == null || !currentDateStr) return;

        const qtyInput = document.getElementById("detail-quantity");
        const liveQty = Number(qtyInput && qtyInput.value) || 0;

        const totalCarbs = computeTotalCarbsForDay(currentDateStr, editingEntryIndex, liveQty);
        el.textContent = totalCarbs.toFixed(1);
      }


      // --- BOTTONI: Giorni successivi / Elimina dai giorni successivi ---
      const btnApplyFuture = document.getElementById("apply-future-btn");
      const btnRemoveFuture = document.getElementById("remove-future-btn");

      btnApplyFuture.addEventListener("click", function (e) {
        e.preventDefault();

        if (editingEntryIndex == null) return;

        const entries = days[currentDateStr] || [];
        if (editingEntryIndex < 0 || editingEntryIndex >= entries.length) return;

        const entry = entries[editingEntryIndex];
        const qty = Number(document.getElementById("detail-quantity").value);

        if (!qty || qty <= 0 || !isFinite(qty)) {
          showAlert("Inserisci una quantità valida.");
          return;
        }

        showConfirm("").then(function (ok) {
          if (!ok) return;


          // aggiorna anche il giorno corrente
          entry.quantity = qty;
          days[currentDateStr] = entries;

          if (!entry.seriesId) {
            entry.seriesId = "s_" + Date.now().toString(36) + "_" + Math.random().toString(16).slice(2);
          }
          copyEntryToFutureSameWeekday(entry.seriesId, entry.foodId, qty);


          saveDays();
          renderDayEntries();
          history.back();
        });
      });

      btnRemoveFuture.addEventListener("click", function (e) {
        e.preventDefault();

        if (editingEntryIndex == null) return;

        const entries = days[currentDateStr] || [];
        if (editingEntryIndex < 0 || editingEntryIndex >= entries.length) return;

        const entry = entries[editingEntryIndex];

        showConfirm(
          "Vuoi eliminare questo alimento da tutti i " +
          dayNames[currentDate.getDay()].toLowerCase() + " successivi?"
        ).then(function (ok) {
          if (!ok) return;

          const sid = ensureSeriesIdForLegacySeriesIfNeeded(entry);
          if (!sid) return; // non era una serie (non esiste nei giorni successivi)

          removeEntryFromFutureSameWeekday(entry.seriesId, entry.foodId);


          saveDays();
          renderDayEntries();
          history.back();
        });
      });



      function updateDetailDayTotalProteinLive() {
        const el = document.getElementById("detail-total-protein");
        if (!el) return;
        if (editingEntryIndex == null || !currentDateStr) return;

        const qtyInput = document.getElementById("detail-quantity");
        const liveQty = Number(qtyInput && qtyInput.value) || 0;

        const totalProt = computeTotalProteinForDay(currentDateStr, editingEntryIndex, liveQty);
        el.textContent = totalProt.toFixed(1);
      }

      // ----------------- DETTAGLIO ALIMENTO -----------------
      function openFoodDetail(index) {
        const entries = days[currentDateStr] || [];
        if (index < 0 || index >= entries.length) return;

        editingEntryIndex = index;
        const entry = entries[index];
        const food = foods[entry.foodId];
        if (!food) return;

        editingFoodId = entry.foodId;

        const overlay = document.getElementById("food-detail-overlay");
        overlay.classList.remove("hidden");
        updateDetailOverlayKeyboardOffset();



        if (!detailOverlayOpen) {
          history.pushState({ detailOverlay: true }, "");
          detailOverlayOpen = true;
        }

        document.getElementById("detail-food-name").textContent = food.name;
        const qtyInput = document.getElementById("detail-quantity");
        qtyInput.value = (Number(entry.quantity) || 0).toString();
        qtyInput.dataset.justOpened = "1";

        updateDetailFoodMacrosLive();
        updateDetailDayTotalProteinLive();
        updateDetailDayTotalFatLive();
        updateDetailDayTotalCarbsLive();

      }

      function closeFoodDetail() {
        const overlay = document.getElementById("food-detail-overlay");
        overlay.classList.add("hidden");
        overlay.style.setProperty("--kb-offset", "0px");
        editingEntryIndex = null;
        editingFoodId = null;
        detailOverlayOpen = false;
      }

      function updateDetailOverlayKeyboardOffset() {
        const overlay = document.getElementById("food-detail-overlay");
        if (!overlay) return;

        // se l’overlay è chiuso, reset
        if (overlay.classList.contains("hidden")) {
          overlay.style.setProperty("--kb-offset", "0px");
          return;
        }

        const vv = window.visualViewport;
        if (!vv) return;

        // stima altezza tastiera
        const kb = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
        overlay.style.setProperty("--kb-offset", kb + "px");
      }

      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", updateDetailOverlayKeyboardOffset);
        window.visualViewport.addEventListener("scroll", updateDetailOverlayKeyboardOffset);
      }




      function propagateSeriesPositionToFutureSameWeekday(seriesId, foodId, targetIndex) {
        if (!currentDate) return;

        const weekday = currentDate.getDay();

        for (let i = 1; i <= 365; i++) {
          const d = new Date(currentDate);
          d.setDate(d.getDate() + i);
          if (d.getDay() !== weekday) continue;

          const dateStr = formatDate(d);
          const arr = days[dateStr];
          if (!arr || !arr.length) continue;

          // 1) se esiste la stessa serie, usa quella
          let from = arr.findIndex(e => e.seriesId === seriesId);

          // 2) ALTRIMENTI: sposta comunque l'alimento (foodId), anche se ha seriesId diverso o nullo
          if (from < 0) {
            from = arr.findIndex(e => e.foodId === foodId);
            if (from >= 0) {
              // opzionale ma consigliato: riallineo alla serie corrente
              arr[from].seriesId = seriesId;
            }
          }

          if (from < 0) continue;

          const [item] = arr.splice(from, 1);

          let idx = Number(targetIndex);
          if (!isFinite(idx)) idx = 0;
          if (idx < 0) idx = 0;
          if (idx > arr.length) idx = arr.length;

          arr.splice(idx, 0, item);
          days[dateStr] = arr;
        }
      }





      // ----------------- PANNELLO INSERISCI CIBO -----------------
      function showAddFoodPanel(show) {
        const panel = document.getElementById("add-food-panel");

        if (show) {
          resetAddFoodPanelState();
          panel.classList.remove("hidden");
          updateStorageUsageUI();

          if (!addFoodPanelOpen) {
            history.pushState({ addFoodPanel: true }, "");
            addFoodPanelOpen = true;
          }
        } else {
          resetAddFoodPanelState();
          panel.classList.add("hidden");
          renderDayEntries();
          addFoodPanelOpen = false;
        }
      }

      function resetAddFoodPanelState() {
        editingBaseFoodId = null;

        const form = document.getElementById("new-food-form");
        if (form) form.reset();

        const search = document.getElementById("search-food-input");
        if (search) search.value = "";

        refreshSearchResults();
      }

      function refreshSearchResults() {
        const container = document.getElementById("search-results");
        const term = document.getElementById("search-food-input").value.toLowerCase().trim();

        container.innerHTML = "";
        const entries = Object.entries(foods);
        if (!entries.length) {
          const p = document.createElement("div");
          p.className = "hint-text";
          p.textContent = "Nessun alimento salvato. Aggiungine uno in 'Nuovo alimento'.";
          container.appendChild(p);
          return;
        }


        const filtered = entries.filter(([id, food]) => {
          if (!term) return true;
          return (food.name || "").toLowerCase().includes(term);
        });

        if (!filtered.length) {
          const p = document.createElement("div");
          p.className = "hint-text";
          p.textContent = "Nessun alimento trovato per questa ricerca.";
          container.appendChild(p);
          return;
        }

        filtered.forEach(([id, food]) => {
          const row = document.createElement("div");
          row.className = "food-search-row";

          const btnAdd = document.createElement("button");
          btnAdd.type = "button";
          btnAdd.className = "food-search-item";
          btnAdd.textContent = food.name;
          btnAdd.addEventListener("click", function () {
            showConfirm("Aggiungi questo alimento alla giornata?").then(function (ok) {
              if (!ok) return;
              addExistingFoodToCurrentDay(id);
            });
          });

          const btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.className = "food-search-edit";
          btnEdit.textContent = "Modifica";
          btnEdit.addEventListener("click", function (e) {
            e.stopPropagation();
            const f = foods[id];
            if (!f) return;

            editingBaseFoodId = id;

            document.getElementById("food-name-input").value = f.name || "";
            document.getElementById("food-kcal-input").value = f.kcalPer100 != null ? f.kcalPer100 : "";
            document.getElementById("food-carbs-input").value = f.carbsPer100 != null ? f.carbsPer100 : "";
            document.getElementById("food-protein-input").value = f.proteinPer100 != null ? f.proteinPer100 : "";
            document.getElementById("food-fat-input").value = f.fatPer100 != null ? f.fatPer100 : "";

            document.getElementById("food-name-input").focus();
          });

          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.className = "food-search-delete";
          btnDel.textContent = "Elimina";
          btnDel.addEventListener("click", function (e) {
            e.stopPropagation();

            const nomeAlimento = food.name || "questo alimento";
            const safeName = escapeHtml(nomeAlimento);

            showDialog({
              type: "confirm",
              html: 'Vuoi eliminare <strong>' + safeName + "</strong>?"
            }).then(function (ok) {
              if (!ok) return;

              delete foods[id];
              saveFoods();
              refreshSearchResults();
            });
          });

          row.appendChild(btnAdd);
          row.appendChild(btnEdit);
          row.appendChild(btnDel);
          container.appendChild(row);
        });
      }

      function addExistingFoodToCurrentDay(foodId) {
        const defaultQuantity = 100;
        const entries = days[currentDateStr] || [];

        entries.push({
          foodId: foodId,
          quantity: defaultQuantity,
          seriesId: generateSeriesId()
        });

        days[currentDateStr] = entries;
        saveDays();
        renderDayEntries();
      }




      function copyEntryToFutureSameWeekday(seriesId, foodId, quantity) {
        if (!currentDate) return;

        const weekday = currentDate.getDay();

        for (let i = 1; i <= 365; i++) {
          const d = new Date(currentDate);
          d.setDate(d.getDate() + i);

          if (d.getDay() !== weekday) continue;

          const dateStr = formatDate(d);
          if (!days[dateStr]) days[dateStr] = [];

          // 1) Cerca per seriesId
          let idx = days[dateStr].findIndex(e => e.seriesId === seriesId);

          if (idx >= 0) {
            days[dateStr][idx].quantity = quantity;
            days[dateStr][idx].foodId = foodId;
            continue;
          }

          // 2) Fallback (migrazione): se esiste lo stesso foodId senza seriesId, aggancialo
          const legacyIdx = days[dateStr].findIndex(e => e.foodId === foodId && !e.seriesId);
          if (legacyIdx >= 0) {
            days[dateStr][legacyIdx].seriesId = seriesId;
            days[dateStr][legacyIdx].quantity = quantity;
            days[dateStr][legacyIdx].foodId = foodId;
            continue;
          }

          // 3) Altrimenti crea nuova entry
          days[dateStr].push({ seriesId: seriesId, foodId: foodId, quantity: quantity });
        }
      }


      function removeEntryFromFutureSameWeekday(seriesId, foodId) {
        if (!currentDate) return;

        const weekday = currentDate.getDay();

        for (let i = 1; i <= 365; i++) {
          const d = new Date(currentDate);
          d.setDate(d.getDate() + i);

          if (d.getDay() !== weekday) continue;

          const dateStr = formatDate(d);
          const dayEntries = days[dateStr];
          if (!dayEntries || !dayEntries.length) continue;

          // Rimuove sia la serie corretta, sia le vecchie copie senza seriesId (legacy)
          days[dateStr] = dayEntries.filter(e => {
            if (e.seriesId === seriesId) return false;
            if (!e.seriesId && e.foodId === foodId) return false;
            return true;
          });

          if (!days[dateStr].length) delete days[dateStr];
        }
      }



      // ----------------- INIT -----------------
      function init() {
        foods = loadFromStorage(STORAGE_KEYS.foods, {});
        days = loadFromStorage(STORAGE_KEYS.days, {});

        cleanupOldDays();

        document.getElementById("prev-day-btn").addEventListener("click", function () {
          if (!currentDate) return;
          const d = new Date(currentDate);
          d.setDate(d.getDate() - 1);
          setCurrentDate(d);
        });

        document.getElementById("next-day-btn").addEventListener("click", function () {
          if (!currentDate) return;
          const d = new Date(currentDate);
          d.setDate(d.getDate() + 1);
          setCurrentDate(d);
        });

        window.addEventListener("popstate", function () {
          const detail = document.getElementById("food-detail-overlay");
          const panel = document.getElementById("add-food-panel");

          if (detailOverlayOpen && detail && !detail.classList.contains("hidden")) {
            closeFoodDetail();
            return;
          }

          if (addFoodPanelOpen && panel && !panel.classList.contains("hidden")) {
            resetAddFoodPanelState();
            panel.classList.add("hidden");
            renderDayEntries();
            addFoodPanelOpen = false;
          }
        });

        document.getElementById("add-food-btn").addEventListener("click", function () {
          showAddFoodPanel(true);
        });

        document.getElementById("back-to-day-btn").addEventListener("click", function () {
          resetAddFoodPanelState();
          history.back();
        });

        document.getElementById("search-food-input").addEventListener("input", refreshSearchResults);

        document.getElementById("close-detail-btn").addEventListener("click", function () {
          history.back();
        });

        const qtyInput = document.getElementById("detail-quantity");

        function clearQtyOnFirstTap() {
          if (qtyInput.dataset.justOpened === "1") {
            qtyInput.value = "";
            qtyInput.dataset.justOpened = "0";

            // macro alimento (NUOVO)
            updateDetailFoodMacrosLive();

            // totali giornata (GIÀ ESISTENTI)
            updateDetailDayTotalProteinLive();
            updateDetailDayTotalFatLive();
            updateDetailDayTotalCarbsLive();
          }
        }

        // Un solo listener input che aggiorna tutto (più stabile e non duplica logica)
        qtyInput.addEventListener("input", () => {
          updateDetailFoodMacrosLive();
          updateDetailDayTotalProteinLive();
          updateDetailDayTotalFatLive();
          updateDetailDayTotalCarbsLive();
        });


        qtyInput.addEventListener("pointerdown", clearQtyOnFirstTap);
        qtyInput.addEventListener("touchstart", clearQtyOnFirstTap);
        qtyInput.addEventListener("mousedown", clearQtyOnFirstTap);

        document.getElementById("food-detail-form").addEventListener("submit", function (e) {
          e.preventDefault();
          if (editingEntryIndex == null) return;

          const entries = days[currentDateStr] || [];
          if (editingEntryIndex < 0 || editingEntryIndex >= entries.length) return;

          const qty = Number(document.getElementById("detail-quantity").value);
          if (!qty || qty <= 0 || !isFinite(qty)) {
            showAlert("Quantità non valida.");
            return;
          }




          entries[editingEntryIndex].quantity = qty;
          days[currentDateStr] = entries;
          saveDays();
          renderDayEntries();
          history.back();
        });

        // --------- SALVATAGGIO NUOVO ALIMENTO ----------
        document.getElementById("new-food-form").addEventListener("submit", function (e) {
          e.preventDefault();

          const name = document.getElementById("food-name-input").value.trim();
          if (!name) {
            showAlert("Inserisci un nome per l'alimento.");
            return;
          }

          const kcal = toNum(document.getElementById("food-kcal-input").value);
          const carbs = toNum(document.getElementById("food-carbs-input").value);
          const prot = toNum(document.getElementById("food-protein-input").value);
          const fat = toNum(document.getElementById("food-fat-input").value);


          if (editingBaseFoodId && foods[editingBaseFoodId]) {
            foods[editingBaseFoodId] = {
              name: name,
              kcalPer100: kcal,
              carbsPer100: carbs,
              proteinPer100: prot,
              fatPer100: fat
            };
            saveFoods();
            editingBaseFoodId = null;
            document.getElementById("new-food-form").reset();
            refreshSearchResults();
            return;
          }

          const id =
            "f_" + Date.now().toString(36) + "_" + Math.random().toString(16).slice(2);

          foods[id] = {
            name: name,
            kcalPer100: kcal,
            carbsPer100: carbs,
            proteinPer100: prot,
            fatPer100: fat
          };
          saveFoods();

          document.getElementById("new-food-form").reset();
          refreshSearchResults();

          const today = new Date();
          const isToday =
            currentDate.getFullYear() === today.getFullYear() &&
            currentDate.getMonth() === today.getMonth() &&
            currentDate.getDate() === today.getDate();

          let labelGiorno;
          if (isToday) {
            labelGiorno = "di oggi";
          } else {
            const d = currentDate.getDate();
            const m = monthNames[currentDate.getMonth()];
            labelGiorno = "del " + d + " " + m;
          }

          showConfirm(
            "Alimento salvato.\nVuoi aggiungerlo subito alla giornata " + labelGiorno + "?"
          ).then(function (ok) {
            if (ok) addExistingFoodToCurrentDay(id);
          });
        });

        const today = new Date();
        setCurrentDate(today);
        updateStorageUsageUI();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>

</html>
