<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <title>Contacalorie giornaliero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">


  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000000;
      color: #ffffff;
      overflow-x: hidden;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .date-label {
      font-weight: 600;
      font-size: 1rem;
      color: #ffffff;
    }

    .date-nav {
      display: flex;
      gap: 2rem;
      /* pi√π spazio tra i due pulsanti */
    }

    #prev-day-btn,
    #next-day-btn {
      padding: 0.7rem 1.2rem;
      /* pulsanti pi√π grandi */
      font-size: 1.5rem;
      /* simboli < e > pi√π grandi */
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      background: #ffffff;
      color: #000000;
      cursor: pointer;
    }

    .btn-secondary {
      background: #4b5563;
      color: #f9fafb;
    }

    .btn-full {
      width: 100%;
      margin-top: 1rem;
      font-size: 1rem;
    }

    #totals {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      /* 4 colonne in una riga */
      gap: 0.5rem;
      margin-bottom: 1rem;
      text-align: center;
      /* valori e label centrati come in foto */
    }


    .total-card {
      background: #111827;
      border-radius: 0.9rem;
      padding: 0.6rem 0.7rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      color: #f9fafb;
    }

    .total-label {
      font-size: 0.8rem;
      color: #ffffff;
      /* bianco */
      font-weight: 400;
      /* regular */
      text-transform: none;
      letter-spacing: 0;
    }


    .total-value {
      font-size: 1rem;
      font-weight: 700;
      margin-top: 0.15rem;
      color: #ffffff;
    }

    #food-list-section {
      margin-bottom: 1rem;
    }

    #empty-day-message {
      font-size: 0.9rem;
      color: #9ca3af;
      text-align: center;
      margin-top: 1rem;
    }

    #food-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .food-item {
      background: #111827;
      border-radius: 0.9rem;
      padding: 0.7rem 0.8rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      transition: transform 0.15s ease-out, opacity 0.15s ease-out;
      touch-action: pan-y;
      color: #f9fafb;
    }

    .food-main {
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    .food-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: #ffffff;
    }

    .food-quantity {
      font-size: 0.9rem;
      color: #ffffff;
      font-weight: 400;
      margin-left: 0.2rem;
      /* QUI decidi tu la distanza dal nome */
    }


    .delete-btn {
      border: none;
      background: #7f1d1d;
      color: #fee2e2;
      border-radius: 999px;
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .overlay.hidden {
      display: none;
    }

    .overlay-content {
      background: #111827;
      border-radius: 1rem;
      padding: 1rem;
      width: calc(100% - 2rem);
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      color: #f9fafb;
      transition: transform 0.2s ease-out;
      /* AGGIUNTO */
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .overlay-title {
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
    }

    .close-btn {
      border: none;
      background: transparent;
      font-size: 1.3rem;
      line-height: 1;
      padding: 0;
      color: #ffffff;
    }

    .field {
      margin-bottom: 0.7rem;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
      color: #e5e7eb;
    }

    .field input {
      width: 100%;
      padding: 0.45rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px solid #374151;
      font-size: 0.9rem;
      background: #000000;
      color: #ffffff;
    }

    .field input::placeholder {
      color: #6b7280;
    }

    .detail-macros {
      display: none;
      /* nasconde Calorie / Carboidrati / Proteine / Grassi */
    }


    .detail-macro-card {
      background: #020617;
      border-radius: 0.7rem;
      padding: 0.4rem 0.5rem;
      color: #f9fafb;
    }

    .detail-macro-label {
      font-size: 0.7rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .detail-macro-value {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 0.1rem;
      color: #ffffff;
    }

    .panel {
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      flex-direction: column;
      z-index: 15;
      color: #ffffff;
    }

    .panel.hidden {
      display: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #1f2933;
      background: #020617;
    }

    .panel-title {
      font-weight: 600;
      font-size: 1rem;
      color: #ffffff;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 1rem 1rem;
      background: #000000;
    }

    .panel-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #ffffff;
    }

    #search-results {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-bottom: 0.9rem;
    }

    .food-search-item {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      padding: 0.35rem 0.7rem;
      font-size: 0.9rem;
      text-align: left;
      color: #f9fafb;
    }

    .food-search-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .food-search-item {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      padding: 0.35rem 0.7rem;
      font-size: 0.9rem;
      text-align: left;
      color: #f9fafb;
      flex: 1;
      /* occupa tutto lo spazio a sinistra */
    }

    .food-search-edit {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      background: #374151;
      color: #f9fafb;
      cursor: pointer;
      flex-shrink: 0;
      margin-right: 0.5rem;
      /* distanza da "Elimina" : puoi aumentare o ridurre questo valore */
    }

    .food-search-delete {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      background: #7f1d1d;
      color: #fee2e2;
      cursor: pointer;
      flex-shrink: 0;
    }



    .hint-text {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.4rem;
    }

    .two-cols {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
    }

    hr {
      border: none;
      border-top: 1px solid #1f2933;
    }

    #storage-usage {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 10rem;
      margin-bottom: 6rem;
    }

    input::selection {
      color: #ffffff;
      background: #374151;
    }

    #detail-quantity::selection {
      color: #ffffff;
      background: #60a5fa;
      /* azzurro pi√π chiaro */
    }

    .detail-actions {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin: 0.5rem 0 0.5rem;
    }



    #back-to-day-btn {
      font-size: 1rem;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
  </style>
</head>


<body>
  <div class="app">
    <header>
      <div class="date-label" id="current-date-label"></div>
      <div class="date-nav">
        <button class="btn btn-secondary" id="prev-day-btn" type="button">&lt;</button>
        <button class="btn btn-secondary" id="next-day-btn" type="button">&gt;</button>
      </div>
    </header>

    <section id="totals">
      <div class="total-card">
        <div class="total-label">Calorie</div>
        <div class="total-value"><span id="total-kcal">0</span></div>
      </div>

      <div class="total-card">
        <div class="total-label">Carboidrati</div>
        <div class="total-value"><span id="total-carbs">0</span> g</div>
      </div>
      <div class="total-card">
        <div class="total-label">Proteine</div>
        <div class="total-value"><span id="total-protein">0</span> g</div>
      </div>
      <div class="total-card">
        <div class="total-label">Grassi</div>
        <div class="total-value"><span id="total-fat">0</span> g</div>
      </div>
    </section>

    <section id="food-list-section">
      <ul id="food-list"></ul>
      <div id="empty-day-message" style="display:none;">
        Nessun alimento inserito per questo giorno.
      </div>
    </section>

    <button class="btn btn-full" id="add-food-btn" type="button">Inserisci cibo</button>
  </div>

  <!-- Dettaglio alimento / modifica quantit√† -->
  <div class="overlay hidden" id="food-detail-overlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <div class="overlay-title" id="detail-food-name"></div>
        <button class="close-btn" id="close-detail-btn" type="button">&times;</button>
      </div>
      <form id="food-detail-form">
        <div class="field">
          <label for="detail-quantity">Grammi</label>
          <input type="number" id="detail-quantity" min="0" step="1" />
        </div>

        <div class="detail-macros">
          ...
        </div>

        <!-- üîπ Nuovi pulsanti per i giorni successivi -->
        <div class="detail-actions">
          <button class="btn btn-secondary" type="button" id="apply-future-btn">
            Giorni successivi
          </button>
          <button class="btn btn-secondary" type="button" id="remove-future-btn">
            Elimina dai giorni successivi
          </button>
        </div>

        <button class="btn btn-full" type="submit">Salva quantit√†</button>
      </form>
    </div>
  </div>

  <!-- Pannello inserisci / cerca cibo -->
  <div class="panel hidden" id="add-food-panel">
    <div class="panel-header">
    </div>
    <div class="panel-body">
      <div class="field">
        <input type="text" id="search-food-input" placeholder="Cerca alimento..." />
      </div>

      <!-- CONTATORE MEMORIA -->

      <div id="search-results"></div>

      <hr />

      <div class="panel-section-title">Nuovo alimento</div>

      <form id="new-food-form">
        <div class="field">
          <input type="text" id="food-name-input" required placeholder="Nome alimento" />
        </div>

        <div class="two-cols">
          <div class="field">
            <label for="food-kcal-input">Calorie</label>
            <input type="number" id="food-kcal-input" min="0" step="0.1" />
          </div>
          <div class="field">
            <label for="food-carbs-input">Carboidrati</label>
            <input type="number" id="food-carbs-input" min="0" step="0.1" />
          </div>
        </div>
        <div class="two-cols">
          <div class="field">
            <label for="food-protein-input">Proteine</label>
            <input type="number" id="food-protein-input" min="0" step="0.1" />
          </div>
          <div class="field">
            <label for="food-fat-input">Grassi</label>
            <input type="number" id="food-fat-input" min="0" step="0.1" />
          </div>
        </div>

        <button class="btn btn-full" type="submit">Salva alimento</button>
        <button class="btn btn-secondary" id="back-to-day-btn" type="button"
          style="margin-top:8rem; display:block; margin-left:auto; margin-right:auto; padding-left:3rem; padding-right:3rem;">
          Indietro
        </button>




        <!-- CONTATORE MEMORIA (spostato qui sotto) -->
        <div id="storage-usage">Memoria usata: --%</div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEYS = {
        foods: "cc_foods_v1",
        days: "cc_days_v1"
      };

      const MAX_STORAGE_BYTES = 5 * 1024 * 1024; // non lo usiamo, ma lo lasciamo

      const dayNames = [
        "Domenica",
        "Luned√¨",
        "Marted√¨",
        "Mercoled√¨",
        "Gioved√¨",
        "Venerd√¨",
        "Sabato"
      ];

      const monthNames = [
        "gennaio",
        "febbraio",
        "marzo",
        "aprile",
        "maggio",
        "giugno",
        "luglio",
        "agosto",
        "settembre",
        "ottobre",
        "novembre",
        "dicembre"
      ];

      let foods = {};
      let days = {};

      let currentDate = null;
      let currentDateStr = "";

      let editingEntryIndex = null;
      let editingFoodId = null;
      let draggedIndex = null;
      let lastDeletedEntry = null;
      let undoTimeoutId = null;
      let editingBaseFoodId = null;
      let addFoodPanelOpen = false;
      let detailOverlayOpen = false;

      // ----------------- UTIL -----------------
      function loadFromStorage(key, defaultValue) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return defaultValue;
          const parsed = JSON.parse(raw);
          return parsed || defaultValue;
        } catch (e) {
          console.warn("Impossibile leggere da localStorage:", e);
          return defaultValue;
        }
      }

      function saveToStorage(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.warn("Impossibile salvare su localStorage:", e);
        }
      }

      function estimateStorageUsageBytes() {
        try {
          let total = 0;
          total += JSON.stringify(foods).length;
          total += JSON.stringify(days).length;
          return total * 2;
        } catch (e) {
          return 0;
        }
      }

      function updateStorageUsageUI() {
        const el = document.getElementById("storage-usage");
        if (!el) return;

        const usedBytes = estimateStorageUsageBytes();
        const usedMB = usedBytes / (1024 * 1024);

        el.textContent =
          "Memoria usata: " + usedMB.toFixed(3) + " MB su 5 MB";
      }

      function saveFoods() {
        saveToStorage(STORAGE_KEYS.foods, foods);
        updateStorageUsageUI();
      }

      function saveDays() {
        saveToStorage(STORAGE_KEYS.days, days);
        updateStorageUsageUI();
      }

      function pad(n) {
        return n < 10 ? "0" + n : "" + n;
      }

      function formatDate(date) {
        return (
          date.getFullYear() +
          "-" +
          pad(date.getMonth() + 1) +
          "-" +
          pad(date.getDate())
        );
      }

      function parseDate(dateStr) {
        const parts = dateStr.split("-");
        if (parts.length !== 3) return null;
        const year = Number(parts[0]);
        const month = Number(parts[1]);
        const day = Number(parts[2]);
        if (!year || !month || !day) return null;
        return new Date(year, month - 1, day);
      }

      function formatDateHuman(date) {
        const dow = dayNames[date.getDay()];
        const d = date.getDate();
        const m = monthNames[date.getMonth()];
        return dow + " " + d + " " + m;
      }

      function escapeHtml(text) {
        if (!text) return "";
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;"
        };
        return text.replace(/[&<>"']/g, function (ch) {
          return map[ch];
        });
      }

      // cancella i giorni pi√π vecchi di 1 mese rispetto ad oggi
      function cleanupOldDays() {
        const now = new Date();
        const cutoff = new Date(
          now.getFullYear(),
          now.getMonth() - 1,
          now.getDate()
        );
        const cutoffStr = formatDate(cutoff);

        let changed = false;
        for (const dateStr in days) {
          if (dateStr <= cutoffStr) {
            delete days[dateStr];
            changed = true;
          }
        }
        if (changed) saveDays();
      }

      // ----------------- GESTIONE GIORNO CORRENTE -----------------
      function setCurrentDate(date) {
        currentDate = new Date(
          date.getFullYear(),
          date.getMonth(),
          date.getDate()
        );

        cleanupOldDays();

        currentDateStr = formatDate(currentDate);

        const today = new Date();
        const isToday =
          currentDate.getFullYear() === today.getFullYear() &&
          currentDate.getMonth() === today.getMonth() &&
          currentDate.getDate() === today.getDate();

        document.getElementById("current-date-label").textContent =
          isToday ? "Oggi" : formatDateHuman(currentDate);

        if (!days[currentDateStr]) {
          days[currentDateStr] = [];
          saveDays();
        }

        renderDayEntries();
      }

      function renderDayEntries() {
        const list = document.getElementById("food-list");
        const emptyMsg = document.getElementById("empty-day-message");

        list.innerHTML = "";

        const entries = days[currentDateStr] || [];

        if (!entries.length) {
          emptyMsg.style.display = "block";
        } else {
          emptyMsg.style.display = "none";
        }

        let totalKcal = 0;
        let totalCarbs = 0;
        let totalProt = 0;
        let totalFat = 0;

        entries.forEach((entry, index) => {
          const food = foods[entry.foodId];
          if (!food) return;

          const quantity = Number(entry.quantity) || 0;
          const factor = quantity / 100;

          const kcal = (Number(food.kcalPer100) || 0) * factor;
          const carbs = (Number(food.carbsPer100) || 0) * factor;
          const prot = (Number(food.proteinPer100) || 0) * factor;
          const fat = (Number(food.fatPer100) || 0) * factor;

          totalKcal += kcal;
          totalCarbs += carbs;
          totalProt += prot;
          totalFat += fat;

          const li = document.createElement("li");
          li.className = "food-item";
          li.dataset.index = String(index);
          li.draggable = true;

          li.innerHTML = `
          <div class="food-main">
            <div class="food-name">${escapeHtml(food.name)}</div>
            <div class="food-quantity">${quantity.toFixed(0)} g</div>
          </div>
        `;

          li.addEventListener("click", function () {
            openFoodDetail(index);
          });

          setupSwipeToDelete(li, index);
          setupDragReorder(li, index);

          list.appendChild(li);
        });

        document.getElementById("total-kcal").textContent =
          totalKcal.toFixed(0);
        document.getElementById("total-carbs").textContent =
          totalCarbs.toFixed(1);
        document.getElementById("total-protein").textContent =
          totalProt.toFixed(1);
        document.getElementById("total-fat").textContent =
          totalFat.toFixed(1);
      }

      function reorderDayEntries(fromIndex, toIndex) {
        const entries = days[currentDateStr] || [];
        if (
          fromIndex < 0 ||
          fromIndex >= entries.length ||
          toIndex < 0 ||
          toIndex >= entries.length
        ) {
          return;
        }

        const moved = entries.splice(fromIndex, 1)[0];
        entries.splice(toIndex, 0, moved);
        days[currentDateStr] = entries;
        saveDays();
        renderDayEntries();
      }

      function setupDragReorder(element, index) {
        element.addEventListener("dragstart", function () {
          draggedIndex = index;
          element.classList.add("dragging");
          element.style.opacity = "0.6";
        });

        element.addEventListener("dragend", function () {
          element.classList.remove("dragging");
          element.style.opacity = "";
          draggedIndex = null;
        });

        element.addEventListener("dragover", function (e) {
          e.preventDefault();
        });

        element.addEventListener("drop", function (e) {
          e.preventDefault();
          if (draggedIndex === null || draggedIndex === index) return;
          reorderDayEntries(draggedIndex, index);
        });
      }

      // ----------------- UNDO ELIMINAZIONE -----------------
      function deleteEntry(index) {
        const entries = days[currentDateStr] || [];
        if (index < 0 || index >= entries.length) return;

        const removed = entries.splice(index, 1)[0];
        days[currentDateStr] = entries;
        saveDays();
        renderDayEntries();

        lastDeletedEntry = {
          entry: removed,
          dateStr: currentDateStr,
          index: index
        };

        showUndoBanner();
      }

      function showUndoBanner() {
        let banner = document.getElementById("undo-banner");
        if (!banner) {
          banner = document.createElement("button");
          banner.id = "undo-banner";
          banner.type = "button";
          banner.textContent = "Ripristina alimento";
          banner.style.display = "block";
          banner.style.width = "100%";
          banner.style.marginTop = "8rem";
          banner.style.padding = "0.5rem 0.9rem";
          banner.style.borderRadius = "999px";
          banner.style.border = "none";
          banner.style.background = "#111827";
          banner.style.color = "#f9fafb";
          banner.style.fontSize = "1rem";
          banner.style.cursor = "pointer";

          const app = document.querySelector(".app");
          const addBtn = document.getElementById("add-food-btn");
          if (app && addBtn && addBtn.parentNode === app) {
            if (addBtn.nextSibling) {
              app.insertBefore(banner, addBtn.nextSibling);
            } else {
              app.appendChild(banner);
            }
          } else if (app) {
            app.appendChild(banner);
          }
        } else {
          banner.style.display = "block";
        }

        banner.onclick = function () {
          if (!lastDeletedEntry) return;

          const { entry, dateStr, index } = lastDeletedEntry;
          const dayEntries = days[dateStr] || [];

          if (index >= 0 && index <= dayEntries.length) {
            dayEntries.splice(index, 0, entry);
          } else {
            dayEntries.push(entry);
          }

          days[dateStr] = dayEntries;
          saveDays();
          if (dateStr === currentDateStr) {
            renderDayEntries();
          }

          lastDeletedEntry = null;
          if (undoTimeoutId) {
            clearTimeout(undoTimeoutId);
            undoTimeoutId = null;
          }
          banner.style.display = "none";
        };

        if (undoTimeoutId) clearTimeout(undoTimeoutId);
        undoTimeoutId = setTimeout(function () {
          if (banner) banner.style.display = "none";
          lastDeletedEntry = null;
        }, 5000);
      }

      function setupSwipeToDelete(element, index) {
        let startX = 0;
        let startY = 0;
        let lastDx = 0;
        let swiping = false;

        element.addEventListener("touchstart", function (e) {
          const t = e.touches[0];
          startX = t.clientX;
          startY = t.clientY;
          lastDx = 0;
          swiping = false;
          element.style.transition = "none";
        });

        element.addEventListener("touchmove", function (e) {
          const t = e.touches[0];
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;

          if (Math.abs(dx) > Math.abs(dy) && dx < -10) {
            swiping = true;
            lastDx = dx;
            element.style.transform = "translateX(" + dx + "px)";
          }
        });

        element.addEventListener("touchend", function () {
          element.style.transition =
            "transform 0.15s ease-out, opacity 0.15s ease-out";
          if (swiping && lastDx < -80) {
            element.style.transform = "translateX(-120%)";
            element.style.opacity = "0";
            setTimeout(function () {
              deleteEntry(index);
            }, 150);
          } else {
            element.style.transform = "translateX(0)";
          }
        });
      }

      // ----------------- DETTAGLIO ALIMENTO -----------------
      function openFoodDetail(index) {
        const entries = days[currentDateStr] || [];
        if (index < 0 || index >= entries.length) return;

        editingEntryIndex = index;
        const entry = entries[index];
        const food = foods[entry.foodId];
        if (!food) return;

        editingFoodId = entry.foodId;

        const overlay = document.getElementById("food-detail-overlay");
        overlay.classList.remove("hidden");

        if (!detailOverlayOpen) {
          history.pushState({ detailOverlay: true }, "");
          detailOverlayOpen = true;
        }

        document.getElementById("detail-food-name").textContent = food.name;
        const qtyInput = document.getElementById("detail-quantity");
        qtyInput.value = (Number(entry.quantity) || 0).toString();

        // segna che il campo √® appena stato aperto
        qtyInput.dataset.justOpened = "1";

        updateDetailMacros();

      }

      function closeFoodDetail() {
        const overlay = document.getElementById("food-detail-overlay");
        overlay.classList.add("hidden");
        editingEntryIndex = null;
        editingFoodId = null;
        detailOverlayOpen = false;
      }

      function updateDetailMacros() {
        if (!editingFoodId) return;
        const food = foods[editingFoodId];
        if (!food) return;

        const qtyInput = document.getElementById("detail-quantity");
        const quantity = Number(qtyInput.value) || 0;
        const factor = quantity / 100;

        const kcal = (Number(food.kcalPer100) || 0) * factor;
        const carbs = (Number(food.carbsPer100) || 0) * factor;
        const prot = (Number(food.proteinPer100) || 0) * factor;
        const fat = (Number(food.fatPer100) || 0) * factor;

        document.getElementById("detail-kcal").textContent = kcal.toFixed(0);
        document.getElementById("detail-carbs").textContent = carbs.toFixed(1);
        document.getElementById("detail-protein").textContent = prot.toFixed(1);
        document.getElementById("detail-fat").textContent = fat.toFixed(1);
      }

      // ----------------- COPIA / ELIMINA GIORNI SUCCESSIVI -----------------
      function copyEntryToFutureSameWeekday(foodId, quantity) {
        if (!currentDate) return;

        const weekday = currentDate.getDay();

        for (let i = 1; i <= 365; i++) {
          const d = new Date(currentDate);
          d.setDate(d.getDate() + i);

          if (d.getDay() !== weekday) continue;

          const dateStr = formatDate(d);

          if (!days[dateStr]) {
            days[dateStr] = [];
          }
          const dayEntries = days[dateStr];

          const existingIndex = dayEntries.findIndex(
            (e) => e.foodId === foodId
          );
          if (existingIndex >= 0) {
            dayEntries[existingIndex].quantity = quantity;
          } else {
            dayEntries.push({
              foodId: foodId,
              quantity: quantity
            });
          }
        }

        saveDays();
      }

      function removeEntryFromFutureSameWeekday(foodId) {
        if (!currentDate) return;

        const weekday = currentDate.getDay();

        for (let i = 1; i <= 365; i++) {
          const d = new Date(currentDate);
          d.setDate(d.getDate() + i);

          if (d.getDay() !== weekday) continue;

          const dateStr = formatDate(d);
          const dayEntries = days[dateStr];
          if (!dayEntries || !dayEntries.length) continue;

          days[dateStr] = dayEntries.filter((e) => e.foodId !== foodId);
        }

        saveDays();
      }

      // ----------------- PANNELLO INSERISCI CIBO -----------------
      function showAddFoodPanel(show) {
        const panel = document.getElementById("add-food-panel");

        if (show) {
          panel.classList.remove("hidden");
          refreshSearchResults();
          updateStorageUsageUI();

          if (!addFoodPanelOpen) {
            history.pushState({ addFoodPanel: true }, "");
            addFoodPanelOpen = true;
          }
        } else {
          panel.classList.add("hidden");
          renderDayEntries();
          addFoodPanelOpen = false;
        }
      }

      function refreshSearchResults() {
        const container = document.getElementById("search-results");
        const term = document
          .getElementById("search-food-input")
          .value.toLowerCase()
          .trim();

        container.innerHTML = "";

        const entries = Object.entries(foods);
        if (!entries.length) return;

        const filtered = entries.filter(([id, food]) => {
          if (!term) return true;
          return (food.name || "").toLowerCase().includes(term);
        });

        if (!filtered.length) {
          const p = document.createElement("div");
          p.className = "hint-text";
          p.textContent = "Nessun alimento trovato per questa ricerca.";
          container.appendChild(p);
          return;
        }

        filtered.forEach(([id, food]) => {
          const row = document.createElement("div");
          row.className = "food-search-row";

          const btnAdd = document.createElement("button");
          btnAdd.type = "button";
          btnAdd.className = "food-search-item";
          btnAdd.textContent = food.name;
          btnAdd.addEventListener("click", function () {
            const conferma = confirm("Aggiungi questo alimento alla giornata?");
            if (!conferma) return;
            addExistingFoodToCurrentDay(id);
          });

          const btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.className = "food-search-edit";
          btnEdit.textContent = "Modifica";
          btnEdit.addEventListener("click", function (e) {
            e.stopPropagation();
            const f = foods[id];
            if (!f) return;

            editingBaseFoodId = id;

            document.getElementById("food-name-input").value = f.name || "";
            document.getElementById("food-kcal-input").value =
              f.kcalPer100 != null ? f.kcalPer100 : "";
            document.getElementById("food-carbs-input").value =
              f.carbsPer100 != null ? f.carbsPer100 : "";
            document.getElementById("food-protein-input").value =
              f.proteinPer100 != null ? f.proteinPer100 : "";
            document.getElementById("food-fat-input").value =
              f.fatPer100 != null ? f.fatPer100 : "";

            document.getElementById("food-name-input").focus();
          });

          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.className = "food-search-delete";
          btnDel.textContent = "Elimina";
          btnDel.addEventListener("click", function (e) {
            e.stopPropagation();
            const conferma = confirm(
              "Vuoi eliminare questo alimento salvato?"
            );
            if (!conferma) return;

            delete foods[id];
            saveFoods();
            refreshSearchResults();
          });

          row.appendChild(btnAdd);
          row.appendChild(btnEdit);
          row.appendChild(btnDel);
          container.appendChild(row);
        });
      }

      function addExistingFoodToCurrentDay(foodId) {
        const defaultQuantity = 100;
        const entries = days[currentDateStr] || [];
        entries.push({
          foodId: foodId,
          quantity: defaultQuantity
        });
        days[currentDateStr] = entries;
        saveDays();
        renderDayEntries();
      }

      // ----------------- INIT -----------------
      function init() {
        foods = loadFromStorage(STORAGE_KEYS.foods, {});
        days = loadFromStorage(STORAGE_KEYS.days, {});

        cleanupOldDays();

        document
          .getElementById("prev-day-btn")
          .addEventListener("click", function () {
            if (!currentDate) return;
            const d = new Date(currentDate);
            d.setDate(d.getDate() - 1);
            setCurrentDate(d);
          });

        document
          .getElementById("next-day-btn")
          .addEventListener("click", function () {
            if (!currentDate) return;
            const d = new Date(currentDate);
            d.setDate(d.getDate() + 1);
            setCurrentDate(d);
          });

        window.addEventListener("popstate", function () {
          const detail = document.getElementById("food-detail-overlay");
          const panel = document.getElementById("add-food-panel");

          if (detailOverlayOpen && detail && !detail.classList.contains("hidden")) {
            closeFoodDetail();
            return;
          }

          if (addFoodPanelOpen && panel && !panel.classList.contains("hidden")) {
            panel.classList.add("hidden");
            renderDayEntries();
            addFoodPanelOpen = false;
          }
        });

        document
          .getElementById("add-food-btn")
          .addEventListener("click", function () {
            showAddFoodPanel(true);
          });

        document
          .getElementById("back-to-day-btn")
          .addEventListener("click", function () {
            history.back();
          });

        document
          .getElementById("search-food-input")
          .addEventListener("input", refreshSearchResults);

        document
          .getElementById("close-detail-btn")
          .addEventListener("click", function () {
            history.back();
          });

        const qtyInput = document.getElementById("detail-quantity");

        // handler unico per svuotare al primo tocco
        function clearQtyOnFirstTap() {
          if (qtyInput.dataset.justOpened === "1") {
            qtyInput.value = "";
            qtyInput.dataset.justOpened = "0"; // da ora in poi non svuota pi√π
            updateDetailMacros();
          }
        }

        // aggiorna i macro mentre scrivi
        qtyInput.addEventListener("input", updateDetailMacros);

        // svuota PRIMA del focus, per qualsiasi tipo di tocco/click
        qtyInput.addEventListener("pointerdown", clearQtyOnFirstTap);
        qtyInput.addEventListener("touchstart", clearQtyOnFirstTap);
        qtyInput.addEventListener("mousedown", clearQtyOnFirstTap);




        document
          .getElementById("food-detail-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            if (editingEntryIndex == null) return;
            const entries = days[currentDateStr] || [];
            if (editingEntryIndex < 0 || editingEntryIndex >= entries.length)
              return;

            const qty = Number(
              document.getElementById("detail-quantity").value
            );
            if (!qty || qty <= 0 || !isFinite(qty)) {
              alert("Quantit√† non valida.");
              return;
            }

            entries[editingEntryIndex].quantity = qty;
            days[currentDateStr] = entries;
            saveDays();
            renderDayEntries();
            history.back();
          });

        // Pulsante "Giorni successivi"
        const btnApplyFuture = document.getElementById("apply-future-btn");
        if (btnApplyFuture) {
          btnApplyFuture.addEventListener("click", function () {
            if (editingEntryIndex == null) return;

            const entries = days[currentDateStr] || [];
            if (
              editingEntryIndex < 0 ||
              editingEntryIndex >= entries.length
            )
              return;

            const entry = entries[editingEntryIndex];
            const qtyInput = document.getElementById("detail-quantity");
            const newQty = Number(qtyInput.value);

            if (!newQty || newQty <= 0 || !isFinite(newQty)) {
              alert(
                "Inserisci una quantit√† valida prima di usare 'Giorni successivi'."
              );
              return;
            }

            // aggiorno il giorno corrente
            entry.quantity = newQty;
            days[currentDateStr] = entries;
            saveDays();
            renderDayEntries();

            const conferma = confirm(
              "Vuoi salvare questo alimento con " +
              newQty +
              " g in tutti i giorni successivi di " +
              dayNames[currentDate.getDay()] +
              "?"
            );
            if (!conferma) return;

            // salva sui giorni futuri
            copyEntryToFutureSameWeekday(entry.foodId, newQty);

            // üîπ TORNA ALLA SCHERMATA PRINCIPALE
            history.back();     // questo chiude il popup "Modifica quantit√†"
          });
        }



        // Pulsante "Elimina giorni succ."
        const btnRemoveFuture = document.getElementById("remove-future-btn");
        if (btnRemoveFuture) {
          btnRemoveFuture.addEventListener("click", function () {
            if (editingEntryIndex == null) return;

            const entries = days[currentDateStr] || [];
            if (
              editingEntryIndex < 0 ||
              editingEntryIndex >= entries.length
            )
              return;

            const entry = entries[editingEntryIndex];

            const conferma = confirm(
              "Vuoi eliminare questo alimento da tutti i " +
              dayNames[currentDate.getDay()].toLowerCase() +
              " successivi?"
            );
            if (!conferma) return;

            removeEntryFromFutureSameWeekday(entry.foodId);

            alert("Alimento eliminato dai giorni futuri corrispondenti.");
          });
        }

        // Adatta il popup quando compare la tastiera
        if (window.visualViewport) {
          const overlayContent = document.querySelector(
            "#food-detail-overlay .overlay-content"
          );

          window.visualViewport.addEventListener("resize", function () {
            if (!overlayContent) return;
            const vv = window.visualViewport;
            const offsetBottom =
              window.innerHeight - vv.height - vv.offsetTop;

            if (offsetBottom > 80) {
              // si sposta solo di una parte dell'altezza della tastiera
              const move = offsetBottom * 0.3; // prova 0.3 / 0.25 / 0.4 per regolare
              overlayContent.style.transform =
                "translateY(-" + move + "px)";
            } else {
              overlayContent.style.transform = "";
            }

          });
        }


        // --------- SALVATAGGIO NUOVO ALIMENTO ----------
        document
          .getElementById("new-food-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const name = document
              .getElementById("food-name-input")
              .value.trim();
            if (!name) {
              alert("Inserisci un nome per l'alimento.");
              return;
            }

            const kcal =
              Number(document.getElementById("food-kcal-input").value) || 0;
            const carbs =
              Number(document.getElementById("food-carbs-input").value) || 0;
            const prot =
              Number(document.getElementById("food-protein-input").value) || 0;
            const fat =
              Number(document.getElementById("food-fat-input").value) || 0;

            if (editingBaseFoodId && foods[editingBaseFoodId]) {
              foods[editingBaseFoodId] = {
                name: name,
                kcalPer100: kcal,
                carbsPer100: carbs,
                proteinPer100: prot,
                fatPer100: fat
              };
              saveFoods();
              editingBaseFoodId = null;
              document.getElementById("new-food-form").reset();
              refreshSearchResults();
              return;
            }

            const id =
              "f_" +
              Date.now().toString(36) +
              "_" +
              Math.random().toString(16).slice(2);

            foods[id] = {
              name: name,
              kcalPer100: kcal,
              carbsPer100: carbs,
              proteinPer100: prot,
              fatPer100: fat
            };
            saveFoods();

            document.getElementById("new-food-form").reset();
            refreshSearchResults();

            const today = new Date();
            const isToday =
              currentDate.getFullYear() === today.getFullYear() &&
              currentDate.getMonth() === today.getMonth() &&
              currentDate.getDate() === today.getDate();

            let labelGiorno;
            if (isToday) {
              labelGiorno = "di oggi";
            } else {
              const d = currentDate.getDate();
              const m = monthNames[currentDate.getMonth()];
              labelGiorno = "del " + d + " " + m;
            }

            const addNow = confirm(
              "Alimento salvato.\nVuoi aggiungerlo subito alla giornata " +
              labelGiorno +
              "?"
            );
            if (addNow) {
              addExistingFoodToCurrentDay(id);
            }
          });

        // --------- AVVIO INIZIALE ----------
        const today = new Date();
        setCurrentDate(today);
        updateStorageUsageUI();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>

</html>